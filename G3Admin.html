<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel G3 Admin</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #00d9ff;
      text-align: center;
    }

    .panel {
      background: #111;
      padding: 20px;
      margin: 15px auto;
      border-radius: 10px;
      max-width: 800px;
      box-shadow: 0 0 15px rgba(0,0,0,0.7);
    }

    input, select, button, textarea {
      margin: 5px;
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 0.95rem;
    }

    input, select, textarea {
      background: #222;
      color: #fff;
    }

    button {
      background: #00d9ff;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #00aacc;
    }

    .user-list {
      margin-top: 15px;
      font-size: 0.9rem;
    }

    .logout {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>⚙️ Painel Administrativo G3 Cloud</h1>

  <div class="panel">
    <h3>Criar Usuário</h3>
    <input type="text" id="newUsername" placeholder="Usuário">
    <input type="password" id="newPassword" placeholder="Senha">
    <select id="newRole">
      <option value="false">Usuário comum</option>
      <option value="true">Administrador</option>
    </select>
    <button onclick="createUser()">Criar</button>
    <p id="createMsg"></p>
  </div>

  <div class="panel">
    <h3>Usuários Cadastrados</h3>
    <button onclick="listUsers()">Atualizar Lista</button>
    <div id="userList" class="user-list"></div>
  </div>

  <div class="panel">
    <h3>Executar SQL (Criar Tabela / Comando Avançado)</h3>
    <textarea id="sqlCommand" rows="4" cols="50" placeholder="Digite um comando SQL..."></textarea><br>
    <button onclick="runSQL()">Executar</button>
    <p id="sqlMsg"></p>
  </div>

  <div class="logout">
    <button onclick="logout()">Sair</button>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const SUPABASE_URL = "https://fobmjibfbbzlnnnmtsct.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function hashPassword(password) {
      return CryptoJS.SHA256(password).toString();
    }

    // Verifica se é admin
    window.onload = function () {
      const session = JSON.parse(localStorage.getItem("loggedUser"));
      if (!session || !session.isAdmin) {
        window.location.href = "login.html";
      }
    };

    async function createUser() {
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const isAdmin = document.getElementById("newRole").value === "true";
      const msg = document.getElementById("createMsg");

      const { error } = await supabase
        .from("users")
        .insert([{ username, password: hashPassword(password), is_admin: isAdmin, is_blocked: false }]);

      if (error) {
        msg.innerText = "Erro ao criar usuário!";
      } else {
        msg.innerText = "Usuário criado com sucesso!";
        listUsers();
      }
    }

    async function listUsers() {
      const { data, error } = await supabase.from("users").select("*");
      const list = document.getElementById("userList");
      if (error) {
        list.innerText = "Erro ao buscar usuários!";
        return;
      }
      list.innerHTML = data.map(u =>
        `<div>
          <b>${u.username}</b> | Admin: ${u.is_admin} | Bloqueado: ${u.is_blocked}
          <button onclick="blockUser('${u.username}', ${!u.is_blocked})">${u.is_blocked ? 'Desbloquear' : 'Bloquear'}</button>
          <button onclick="deleteUser('${u.username}')">Excluir</button>
        </div>`
      ).join("");
    }

    async function blockUser(username, block) {
      await supabase.from("users").update({ is_blocked: block }).eq("username", username);
      listUsers();
    }

    async function deleteUser(username) {
      await supabase.from("users").delete().eq("username", username);
      listUsers();
    }

    async function runSQL() {
      const sql = document.getElementById("sqlCommand").value;
      const msg = document.getElementById("sqlMsg");
      // Supabase client JS não roda SQL direto, precisaria de RPC/Edge Functions
      msg.innerText = "⚠️ Execução SQL direta não é suportada pelo cliente JS. Use Supabase SQL editor.";
    }

    function logout() {
      localStorage.removeItem("loggedUser");
      window.location.href = "login.html";
    }
  </script>
</body>
</html>